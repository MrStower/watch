#define F_CPU 1000000L
#include <avr/io.h>
#include <util/delay.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>
#include <avr/sleep.h>
#define I2C_DDR		DDRB	// Порт для выбора направления
#define I2C_PORT	PORTB	// Порт для вывода данных
#define I2C_PIN		PINB	// Порт для ввода данных

#define SCL			6		// Пин порта SCL
#define SDA			7		// Пин порта SDA

//-------------------------------------------------------------------------
//						Объявление служебных псевдонимов
//-------------------------------------------------------------------------

#define ACK  0		// Ответ удачный
#define NACK 1		// Ответ не удачный

#define I2C_DELAY()	_delay_us(10);	// Общая пауза на шине

#define ONE_SCL()	{ I2C_DDR &= ~(1 << SCL); I2C_PORT |= (1 << SCL); }  // Установка единицы на линии SCL
#define NULL_SCL()	{ I2C_DDR |= (1 << SCL);  I2C_PORT &= ~(1 << SCL); } // Установка нуля на линии SCL
#define ONE_SDA()	{ I2C_DDR &= ~(1 << SDA); I2C_PORT |= (1 << SDA); }  // Установка единицы на линии SDA
#define NULL_SDA()	{ I2C_DDR |= (1 << SDA);  I2C_PORT &= ~(1 << SDA); } // Установка нуля на линии SDA

#define OK				0	// Линия в норме
#define SCL_FAIL		1	// Ошибка линии SCL
#define SDA_FAIL		2	// Ошибка линии SDA
#define SDA_SCL_FAIL	3	// Ошибка линий SCL и SDA

#define WR				0   // Бит на запись
#define RD				1	// Бит на чтение
#define NO				2	// Бит не требуется

// Адрес устройства

#define DS3231_ADD_W				0xD0
#define DS3231_ADD_R				0xD1

// Адреса регистров

#define DS3231_SECONDS				0x00	// Адрес регистра секунд
#define DS3231_MINUTES				0x01	// Адрес регистра минут
#define DS3231_HOURS				0x02	// Адрес регистра часов
#define DS3231_DAY					0x03	// Адрес регистра дня недели
#define DS3231_DATE					0x04	// Адрес регистра числа
#define DS3231_MONTH				0x05	// Адрес регистра месяца
#define DS3231_YEAR					0x06	// Адрес регистра года
#define DS3231_ALARM_1_SEC			0x07	// Адрес регистра будильника 1 секунд
#define DS3231_ALARM_1_MIN			0x08	// Адрес регистра будильника 1 минут
#define DS3231_ALARM_1_HOR			0x09	// Адрес регистра будильника 1 часов
#define DS3231_ALARM_1_DAY			0x0A	// Адрес регистра будильника 1 дня недели
#define DS3231_ALARM_1_DAT			0x0A	// Адрес регистра будильника 1 числа
#define DS3231_ALARM_2_MIN			0x0B	// Адрес регистра будильника 2 минут
#define DS3231_ALARM_2_HOR			0x0C	// Адрес регистра будильника 2 часов
#define DS3231_ALARM_2_DAY			0x0D	// Адрес регистра будильника 2 вдя недели
#define DS3231_ALARM_2_DAT			0x0D	// Адрес регистра будильника 2 числа
#define DS3231_CONTROL				0x0E	// Адрес регистра управления
#define DS3231_STATUS				0x0F	// Адрес регистра состояния
#define DS3231_SET_CLOCK			0x10	// Адрес регистра корректировки частоты генератора времяни (0x81 - 0x7F)
#define DS3231_T_MSB				0x11	// Адрес регистра последней измеренной температуры старшиий байт
#define DS3231_T_LSB				0x12	// Адрес регистра последней измеренной температуры младшиий байт

// Режим вывода часов

#define DS3231_HOURS_12				0x40
#define DS3231_24					0x3F
#define DS3231_AM					0x5F
#define DS3231_PM					0x60
#define DS3231_GET_24				0x02
#define DS3231_GET_PM				0x01
#define DS3231_GET_AM				0x00

// Разряды регистров

#define DS3231_A1M1					0x07
#define DS3231_A1M2					0x07
#define DS3231_A1M3					0x07
#define DS3231_A1M4					0x07
#define DS3231_A2M2					0x07
#define DS3231_A2M3					0x07
#define DS3231_A2M4					0x07
#define DS3231_DY_DT				0x06
#define DS3231_EOSC					0x07
#define DS3231_BBSQW				0x06
#define DS3231_CONV					0x05
#define DS3231_INTCN				0x02
#define DS3231_A2IE					0x01
#define DS3231_A1IE					0x00
#define DS3231_OSF					0x07
#define DS3231_EN32KHZ				0x03
#define DS3231_BSY					0x02
#define DS3231_A2F					0x01
#define DS3231_A1F					0x00
#define DS3231_SIGN					0x07

// Вспомогательные данные функций

#define DS3231_ERR					0
#define DS3231_OK					1
#define DS3231_ON					1
#define DS3231_OFF					0

// Будильники

#define DS3231_ALARM_1				0x00
#define DS3231_ALARM_2				0x01
#define DS3231_ALARM_OFF			0x00
#define DS3231_ALARM_1_ON			0x01
#define DS3231_ALARM_2_ON			0x02
#define DS3231_ALARM_ALL_ON			0x03

uint8_t i2c_stop(void)
{
	char error = OK;
	
	NULL_SCL();
	I2C_DELAY();
	NULL_SDA();
	I2C_DELAY();
	
	ONE_SCL();
	I2C_DELAY();
	ONE_SDA();
	I2C_DELAY();
	
	if((I2C_PIN & (1 << SDA)) == 0) error = SDA_FAIL;
	if((I2C_PIN & (1 << SCL)) == 0) error += SCL_FAIL;
	I2C_DELAY();
	I2C_DELAY();
	I2C_DELAY();
	I2C_DELAY();
	
	return error;
}
void i2c_start(void)
{
	NULL_SDA();
	I2C_DELAY();
	NULL_SCL();
	I2C_DELAY();
}
void i2c_restart(void)
{
	ONE_SDA();
	I2C_DELAY();
	ONE_SCL();
	I2C_DELAY();
	
	NULL_SDA();
	I2C_DELAY();
	NULL_SCL();
	I2C_DELAY();
}
void i2c_init(void)
{
	ONE_SDA();
	ONE_SCL();
	
	i2c_stop();
}
uint8_t i2c_send_byte(char data)
{
	char i;
	char ask = ACK;
	
	for(i = 0; i < 8; i++)
	{
		if((data & 0x80) == 0)
		{
			NULL_SDA();
		}
		else
		{
			ONE_SDA();
		}
		I2C_DELAY();
		ONE_SCL();
		I2C_DELAY();
		NULL_SCL();
		
		data = (data << 1);
	}
	
	ONE_SDA();
	I2C_DELAY();
	ONE_SCL();
	I2C_DELAY();
	
	if((I2C_PIN & (1 << SDA)) == (1 << SDA))
	{
		ask = NACK;
	}
	else
	{
		ask = ACK;
	}
	
	NULL_SCL();
	
	return ask;
}
uint8_t i2c_read_byte(char ask)
{
	char byte = 0;
	char i;
	
	ONE_SDA();
	
	for(i = 0; i < 8; i++)
	{
		byte = (byte << 1);
		ONE_SCL();
		I2C_DELAY();
		if((I2C_PIN & (1 << SDA)) == (1 << SDA)) byte |= 0x01;
		NULL_SCL();
		I2C_DELAY();
	}
	
	if(ask == ACK)
	{
		NULL_SDA();
	}
	else
	{
		ONE_SDA();
	}
	I2C_DELAY();
	ONE_SCL();
	I2C_DELAY();
	NULL_SCL();
	I2C_DELAY();
	ONE_SDA();
	
	return byte;
}
void ds3231_init(void)
{
	uint8_t temp = 0;
	i2c_init();
	
	i2c_start();
	i2c_send_byte(DS3231_ADD_W);
	i2c_send_byte(DS3231_CONTROL);
	i2c_restart();
	i2c_send_byte(DS3231_ADD_R);
	temp = i2c_read_byte(NACK);
	i2c_stop();
	
	i2c_start();
	i2c_send_byte(DS3231_ADD_W);
	i2c_send_byte(DS3231_CONTROL);
	i2c_restart();
	i2c_send_byte(temp & 0x7F);
	i2c_stop();
}
void ds3231_write_reg(uint8_t reg, uint8_t data)
{
	i2c_start();
	i2c_send_byte(DS3231_ADD_W);
	i2c_send_byte(reg);
	i2c_send_byte(data);
	i2c_stop();
}
uint8_t ds3231_read_reg(uint8_t reg)
{
	uint8_t temp = 0;
	
	i2c_start();
	i2c_send_byte(DS3231_ADD_W);
	i2c_send_byte(reg);
	i2c_restart();
	i2c_send_byte(DS3231_ADD_R);
	temp = i2c_read_byte(NACK);
	i2c_stop();
	
	return temp;
}
uint8_t ds3231_byte(uint8_t data)
{
	uint8_t temp = 0;
	
	while(data > 9)
	{
		data -= 10;
		temp++;
	}
	
	return (data | (temp << 4));
}
uint8_t ds3231_read_time(uint8_t *str)
{
	uint8_t temp[3];
	uint8_t i = 0;
	uint8_t hour = 0;
	
	i2c_start();
	i2c_send_byte(DS3231_ADD_W);
	i2c_send_byte(DS3231_SECONDS);
	i2c_restart();
	i2c_send_byte(DS3231_ADD_R);
	temp[2] = i2c_read_byte(ACK);
	temp[1] = i2c_read_byte(ACK);
	temp[0] = i2c_read_byte(NACK);
	i2c_stop();
	
	if(temp[0] & 0x40) // AM/PM
	{
		*str = ((temp[0] & 0x0F)+(((temp[0] >> 4) & 0x01) * 10));
		str++;
		
		hour = ((temp[0] >> 5) & 0x01);
		
		i = 1;
		while(i < 3)
		{
			*str = ((temp[i] & 0x0F)+((temp[i] >> 4) * 10));
			str++;
			i++;
		}
	}
	else // 24
	{
		i = 0;
		while(i < 3)
		{
			*str = ((temp[i] & 0x0F)+((temp[i] >> 4) * 10));
			str++;
			i++;
		}
		hour = DS3231_GET_24;
	}
	return hour;
}
void ds3231_write_time(uint8_t h1224, uint8_t hours, uint8_t minutes, uint8_t seconds)
{
	i2c_start();
	i2c_send_byte(DS3231_ADD_W);
	i2c_send_byte(DS3231_SECONDS);
	i2c_send_byte(ds3231_byte(seconds));
	i2c_send_byte(ds3231_byte(minutes));
	
	if(h1224 == DS3231_24)
	{
		i2c_send_byte(ds3231_byte(hours) & DS3231_24);
	}
	else
	{
		if(h1224 == DS3231_AM)
		{
			if(hours > 12) hours -= 12;
			i2c_send_byte((ds3231_byte(hours) & DS3231_AM) | DS3231_HOURS_12);
		}
		else
		{
			if(hours > 12) hours -= 12;
			i2c_send_byte(ds3231_byte(hours)| DS3231_PM);
		}
	}
	
	i2c_stop();
}
void ds3231_read_data(uint8_t *str)
{
	uint8_t temp[4];
	uint8_t i = 0;
	
	i2c_start();
	i2c_send_byte(DS3231_ADD_W);
	i2c_send_byte(DS3231_DAY);
	i2c_restart();
	i2c_send_byte(DS3231_ADD_R);
	*str = i2c_read_byte(ACK);
	temp[0] = i2c_read_byte(ACK);
	temp[1] = i2c_read_byte(ACK);
	temp[2] = i2c_read_byte(NACK);
	i2c_stop();
	
	str++;
	while(i < 4)
	{
		*str = ((temp[i] & 0x0F)+((temp[i] >> 4) * 10));
		str++;
		i++;
	}
}
void ds3231_write_data(uint8_t data, uint8_t day, uint8_t month, uint8_t year)
{
	i2c_start();
	i2c_send_byte(DS3231_ADD_W);
	i2c_send_byte(DS3231_DAY);
	i2c_send_byte(data);
	i2c_send_byte(ds3231_byte(day));
	i2c_send_byte(ds3231_byte(month));
	i2c_send_byte(ds3231_byte(year));
	i2c_stop();
}
void ds3231_sqw_on(uint8_t rs)
{
	uint8_t temp = 0;
	
	temp = ds3231_read_reg(DS3231_CONTROL);
	temp &= 0xA0;
	temp |= ((1 << DS3231_BBSQW) | rs);
	
	ds3231_write_reg(DS3231_CONTROL, temp);
}
void ds3231_en32khz(uint8_t level)
{
	uint8_t temp = 0;
	
	temp = ds3231_read_reg(DS3231_STATUS);
	
	if(DS3231_ON == level)
	{
		temp |= (1 << DS3231_EN32KHZ);
	}
	else
	{
		temp &= ~(1 << DS3231_EN32KHZ);
	}
	
	ds3231_write_reg(DS3231_STATUS, temp);
}
void ds3231_set_alarm(uint8_t alarm, uint8_t h1224, uint8_t hours, uint8_t minutes)
{
	uint8_t control_reg = 0;
	uint8_t ststus_reg = 0;
	uint8_t alarm_reg = 0;
	
	// Выключение SQW, разрешение прерывания будильника и вывод включение вывода состояния.
	
	control_reg = ds3231_read_reg(DS3231_CONTROL);
	control_reg |= (1 << alarm) | (1 << DS3231_INTCN) | (1 << DS3231_BBSQW);
	ds3231_write_reg(DS3231_CONTROL, control_reg);
	
	ds3231_write_reg(DS3231_ALARM_1_SEC, 0x00);
	
	// Запись времяни в будильник
	if(alarm == DS3231_ALARM_1) alarm_reg = DS3231_ALARM_1_MIN;
	if(alarm == DS3231_ALARM_2) alarm_reg = DS3231_ALARM_2_MIN;
	i2c_start();
	i2c_send_byte(DS3231_ADD_W);
	i2c_send_byte(alarm_reg);
	i2c_send_byte(ds3231_byte(minutes));

	if(h1224 == DS3231_24)
	{
		i2c_send_byte((ds3231_byte(hours) & DS3231_24) | (1 << DS3231_A1M3));
	}
	else
	{
		if(h1224 == DS3231_AM)
		{
			if(hours > 12) hours -= 12;
			i2c_send_byte((ds3231_byte(hours) & DS3231_AM) | DS3231_HOURS_12 | (1 << DS3231_A1M3));
		}
		else
		{
			if(hours > 12) hours -= 12;
			i2c_send_byte((ds3231_byte(hours)| DS3231_PM) | (1 << DS3231_A1M3));
		}
	}
	
	i2c_send_byte(ds3231_byte(0x80));
	i2c_stop();
	
	ststus_reg = ds3231_read_reg(DS3231_STATUS);
	ststus_reg &= 0xFC;
	ds3231_write_reg(DS3231_STATUS, ststus_reg);
}
#define DEL 50
#define WAIT 10
#define MENU_LENGTH 5
uint8_t delay=DEL;
uint8_t state=0x00;
uint8_t bt_wait=WAIT;
uint8_t menu_selected=0;
uint8_t menu_now=1;
uint8_t bt_wait_sel_u=WAIT;
uint8_t bt_wait_sel_d=WAIT;
uint8_t minutes_old=0;
uint8_t time[3];
uint8_t date[8];

const uint8_t font8px[] PROGMEM={
	0x3E, //  #####
	0x51, // #     #
	0x49, // # ### #
	0x45, // #     #
	0x3E, //  #####

	0x00, //
	0x42, //  #
	0x7F, // #
	0x40, // ########
	0x00, //

	0x42, //  #     #
	0x61, // #     ##
	0x51, // #    # #
	0x49, // #   #  #
	0x46, //  ###   #

	0x21, //  #    #
	0x41, // #      #
	0x45, // #  #   #
	0x4B, // #  #   #
	0x31, //  ## ###

	0x18, //     ##
	0x14, //   ## #
	0x12, //  #   #
	0x7E, // ########
	0x10, //      #

	0x27, // ####   #
	0x45, // #  #   #
	0x45, // #  #   #
	0x45, // #  #   #
	0x39, // #   ###

	0x3C, //   #####
	0x4A, //  # #   #
	0x49, // #  #   #
	0x49, // #  #   #
	0x30, // #   ###

	0x01, // #
	0x71, // #      #
	0x09, // #   ###
	0x05, // # ##
	0x03, // ##

	0x36, //  ## ###
	0x49, // #  #   #
	0x49, // #  #   #
	0x49, // #  #   #
	0x36, //  ##  ##

	0x06, //  ###   #
	0x49, // #   #  #
	0x49, // #   #  #
	0x49, // #   # #
	0x3E, //  #####
	
	0x02, //           #
	0x04, //         ##
	0x08, //       ##
	0x10, //     ##
	0x20, //    #
};
const uint8_t font_small[] PROGMEM={
	0x20,0x54,0x54,0x54,0x78,//а 1
	0x3c,0x4a,0x4a,0x49,0x31,//б 2
	0x7c,0x54,0x54,0x28,0x00,//в 3
	0x7c,0x04,0x04,0x04,0x0c,//г 4
	0x31,0x49,0x49,0x4a,0x3c,//д 5
	0x38,0x54,0x54,0x54,0x18,//е 6
	0x6c,0x10,0x7c,0x10,0x6c,//ж 7
	0x44,0x54,0x54,0x54,0x28,//з 8
	0x7c,0x20,0x10,0x08,0x7c,//и 9
	0x7c,0x20,0x12,0x08,0x7c,//й 10
	0x7c,0x10,0x10,0x28,0x44,//к 11
	0x20,0x44,0x3c,0x04,0x7c,//л 12
	0x7c,0x08,0x10,0x08,0x7c,//м 13
	0x7c,0x10,0x10,0x10,0x7c,//н 14
	0x38,0x44,0x44,0x44,0x38,//о 15
	0x7c,0x04,0x04,0x04,0x7c,//п 16
	0x7c,0x14,0x14,0x14,0x08,//р 17
	0x38,0x44,0x44,0x44,0x44,//с 18
	0x04,0x04,0x7c,0x04,0x04,//т 19
	0x0c,0x50,0x50,0x50,0x3c,//у 20
	0x18,0x24,0x7e,0x24,0x18,//ф 21
	0x44,0x28,0x10,0x28,0x44,//х 22
	0x7c,0x40,0x40,0x40,0xfc,//ц 23
	0x0c,0x10,0x10,0x10,0x7c,//ч 24
	0x7c,0x40,0x70,0x40,0x7c,//ш 25
	0x7c,0x40,0x70,0x40,0xfc,//щ 26
	0x04,0x7c,0x50,0x50,0x20,//ъ 27
	0x7c,0x50,0x20,0x00,0x7c,//ы 28
	0x7c,0x50,0x50,0x20,0x00,//ь 29
	0x28,0x44,0x54,0x54,0x38,//э 30
	0x7c,0x10,0x38,0x44,0x38,//ю 31
	0x08,0x54,0x34,0x14,0x7c, //я 32
	
	0x7e,0x11,0x11,0x11,0x7e,//А 33
	0x7f,0x49,0x49,0x49,0x33,//Б 34
	0x7f,0x49,0x49,0x49,0x36,//В 35
	0x7f,0x01,0x01,0x01,0x03,//Г 36
	0x70,0x29,0x27,0x21,0x7f,//Д 37
	0x7f,0x49,0x49,0x49,0x49,//Е 38
	0x77,0x08,0x3e,0x08,0x77,//Ж 39
	0x48,0x49,0x49,0x49,0x36,//З 40
	0x7f,0x10,0x08,0x04,0x7f,//И 41
	0x7f,0x10,0x09,0x04,0x7f,//Й 42
	0x7f,0x08,0x14,0x22,0x41,//К 43
	0x20,0x41,0x3F,0x01,0x7f,//Л 44
	0x7f,0x04,0x08,0x04,0x7f,//М 45
	0x7f,0x08,0x08,0x08,0x7f,//Н 46
	0x3e,0x41,0x41,0x41,0x3e,//О 47
	0x7f,0x01,0x01,0x01,0x7f,//П 48
	0x7f,0x09,0x09,0x09,0x06,//Р 49
	0x3e,0x41,0x41,0x41,0x22,//С 50
	0x03,0x01,0x7f,0x01,0x03,//Т 51
	0x47,0x48,0x48,0x48,0x3f,//У 52
	0x1c,0x22,0x7f,0x22,0x1c,//Ф 53
	0x63,0x14,0x08,0x14,0x63,//Х 54
	0x7f,0x40,0x40,0x40,0xff,//Ц 55
	0x07,0x08,0x08,0x08,0x7f,//Ч 56
	0x7f,0x40,0x78,0x40,0xff,//Ш 57
	0x7f,0x40,0x78,0x40,0xff,//Щ 58
	0x01,0x7f,0x48,0x48,0x30,//Ъ 59
	0x7f,0x48,0x30,0x00,0x7f,//Ы 60
	0x7f,0x48,0x48,0x48,0x30,//Ь 61
	0x22,0x41,0x49,0x49,0x3f,//Э 62
	0x7f,0x08,0x3e,0x49,0x3e,//Ю 63
	0x66,0x19,0x09,0x09,0x7f,//Я 64
	0x00,0xa0,0x60,0x00,0x00,//, 65
	0x00,0x60,0x60,0x00,0x00,//. 66
	0x00,0x36,0x36,0x00,0x00,//: 67
	0x04,0x08,0x51,0x09,0x06,//? 68
	0x00,0x00,0x5f,0x00,0x00,//! 69
	0x41,0x22,0x14,0x08,0x00,//> 70
	0x08,0x14,0x22,0x41,0x00,//< 71
};
const uint8_t font36px_line0[] PROGMEM={
	// @0 '0' (22 pixels wide)
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0xF8, 0x00, 0x00, //                 #####
	0x00, 0x7F, 0xFF, 0xE0, 0x00, //          ##################
	0x03, 0xFF, 0xFF, 0xFC, 0x00, //       ########################
	0x07, 0xFF, 0xFF, 0xFF, 0x00, //      ###########################
	0x1F, 0xFF, 0xFF, 0xFF, 0x80, //    ##############################
	0x3F, 0xF0, 0x00, 0x3F, 0xC0, //   ##########              ########
	0x3F, 0xF8, 0x00, 0x07, 0xE0, //   ###########                ######
	0x7C, 0xFE, 0x00, 0x01, 0xE0, //  #####  #######                ####
	0x78, 0x7F, 0x80, 0x01, 0xE0, //  ####    ########              ####
	0x70, 0x1F, 0xC0, 0x00, 0xF0, //  ###       #######              ####
	0x70, 0x07, 0xF0, 0x00, 0xF0, //  ###         #######            ####
	0x70, 0x03, 0xFC, 0x00, 0xF0, //  ###          ########          ####
	0x70, 0x00, 0xFF, 0x00, 0xF0, //  ###            ########        ####
	0x78, 0x00, 0x3F, 0x80, 0xF0, //  ####             #######       ####
	0x78, 0x00, 0x1F, 0xE1, 0xE0, //  ####              ########    ####
	0x7C, 0x00, 0x07, 0xFB, 0xE0, //  #####               ######## #####
	0x3F, 0x00, 0x03, 0xFF, 0xC0, //   ######              ############
	0x1F, 0xE0, 0x00, 0xFF, 0xC0, //    ########             ##########
	0x1F, 0xFF, 0xFF, 0xFF, 0x80, //    ##############################
	0x07, 0xFF, 0xFF, 0xFE, 0x00, //      ##########################
	0x01, 0xFF, 0xFF, 0xF8, 0x00, //        ######################
	0x00, 0x3F, 0xFF, 0xC0, 0x00, //           ################
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,


	// @110 '1' (12 pixels wide)
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x20, 0x00, //                            #
	0x00, 0x00, 0x00, 0x70, 0x00, //                           ###
	0x00, 0x00, 0x00, 0xF8, 0x00, //                          #####
	0x00, 0x00, 0x00, 0x7C, 0x00, //                           #####
	0x00, 0x00, 0x00, 0x3E, 0x00, //                            #####
	0x00, 0x00, 0x00, 0x1F, 0x00, //                             #####
	0x00, 0x00, 0x00, 0x0F, 0x80, //                              #####
	0x00, 0x00, 0x00, 0x07, 0xC0, //                               #####
	0x7F, 0xFF, 0xFF, 0xFF, 0xE0, //  ###################################
	0x7F, 0xFF, 0xFF, 0xFF, 0xE0, //  ###################################
	0x7F, 0xFF, 0xFF, 0xFF, 0xE0, //  ###################################
	0x7F, 0xFF, 0xFF, 0xFF, 0xE0, //  ###################################
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,


	// @170 '2' (21 pixels wide)
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x7C, 0x00, 0x00, 0x00, 0x00, //  ####
	0x7E, 0x00, 0x00, 0x03, 0x00, //  #####                        ##
	0x7F, 0x00, 0x00, 0x0F, 0x80, //  ######                     #####
	0x7F, 0x80, 0x00, 0x07, 0x80, //  #######                     ####
	0x7F, 0xC0, 0x00, 0x03, 0xC0, //  ########                     ####
	0x7F, 0xE0, 0x00, 0x03, 0xC0, //  ##########                   ####
	0x79, 0xF0, 0x00, 0x01, 0xC0, //  #### ######                   ###
	0x78, 0xF8, 0x00, 0x01, 0xE0, //  ####  ######                  ####
	0x78, 0x7C, 0x00, 0x01, 0xE0, //  ####   ######                 ####
	0x78, 0x3E, 0x00, 0x01, 0xE0, //  ####     #####                ####
	0x78, 0x1F, 0x00, 0x01, 0xE0, //  ####      #####               ####
	0x78, 0x0F, 0x80, 0x01, 0xE0, //  ####       #####              ####
	0x78, 0x07, 0xC0, 0x01, 0xE0, //  ####        #####             ####
	0x78, 0x03, 0xF0, 0x03, 0xE0, //  ####         ######          #####
	0x78, 0x01, 0xF8, 0x03, 0xC0, //  ####          ######         ####
	0x78, 0x00, 0xFF, 0x1F, 0xC0, //  ####           ########   #######
	0x78, 0x00, 0x7F, 0xFF, 0x80, //  ####            ################
	0x78, 0x00, 0x1F, 0xFF, 0x00, //  ####              #############
	0x78, 0x00, 0x0F, 0xFE, 0x00, //  ####               ###########
	0x78, 0x00, 0x01, 0xF8, 0x00, //  ####                  ######
	0x78, 0x00, 0x00, 0x00, 0x00, //  ####
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,


	// @275 '3' (22 pixels wide)
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x1E, 0x00, 0x00, 0x00, 0x00, //    ####                        
	0x3C, 0x00, 0x00, 0x03, 0x00, //   ####                        ##
	0x3C, 0x00, 0x00, 0x07, 0x80, //   ####                       ####
	0x38, 0x00, 0x00, 0x07, 0xC0, //   ###                        #####
	0x78, 0x00, 0x00, 0x03, 0xC0, //  ####                         ####
	0x78, 0x00, 0xF0, 0x03, 0xC0, //  ####            ##            ####
	0x78, 0x00, 0xF0, 0x01, 0xE0, //  ####           ####           ####
	0x78, 0x00, 0xF0, 0x01, 0xE0, //  ####           ####           ####
	0x78, 0x00, 0xF0, 0x01, 0xE0, //  ####           ####           ####
	0x78, 0x00, 0xF0, 0x01, 0xE0, //  ####           ####           ####
	0x78, 0x00, 0xF0, 0x01, 0xE0, //  ####           ####           ####
	0x78, 0x00, 0xF0, 0x01, 0xE0, //  ####           ####           ####
	0x78, 0x00, 0xF8, 0x01, 0xE0, //  ####           #####          ####
	0x78, 0x00, 0xF8, 0x01, 0xE0, //  ####           #####          ####
	0x3C, 0x01, 0xFC, 0x03, 0xE0, //   ####         #######        #####
	0x3C, 0x01, 0xDE, 0x03, 0xC0, //   ####         ### ####       ####
	0x3E, 0x03, 0xDF, 0x8F, 0xC0, //   #####       #### ######   ######
	0x1F, 0x8F, 0x8F, 0xFF, 0x80, //    ######   #####   #############
	0x1F, 0xFF, 0x87, 0xFF, 0x80, //    ##############    ############
	0x0F, 0xFF, 0x03, 0xFE, 0x00, //     ############      #########
	0x07, 0xFE, 0x00, 0xFC, 0x00, //      ##########         ######
	0x01, 0xFC, 0x00, 0x00, 0x00, //        #######
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,


	// @385 '4' (26 pixels wide)
	0x00, 0xF8, 0x00, 0x00, 0x00, //         #####
	0x00, 0xFC, 0x00, 0x00, 0x00, //         ######
	0x00, 0xFE, 0x00, 0x00, 0x00, //         #######
	0x00, 0xFF, 0x80, 0x00, 0x00, //         #########
	0x00, 0xFF, 0xC0, 0x00, 0x00, //         ##########
	0x00, 0xF3, 0xF0, 0x00, 0x00, //         ####  ######
	0x00, 0xF1, 0xF8, 0x00, 0x00, //         ####   ######
	0x00, 0xF0, 0x7C, 0x00, 0x00, //         ####     #####
	0x00, 0xF0, 0x3F, 0x00, 0x00, //         ####      ######
	0x00, 0xF0, 0x1F, 0x80, 0x00, //         ####       ######
	0x00, 0xF0, 0x07, 0xC0, 0x00, //         ####         #####
	0x00, 0xF0, 0x03, 0xF0, 0x00, //         ####          ######
	0x00, 0xF0, 0x01, 0xF8, 0x00, //         ####           ######
	0x00, 0xF0, 0x00, 0x7E, 0x00, //         ####             ######
	0x00, 0xF0, 0x00, 0x3F, 0x00, //         ####              ######
	0x00, 0xF0, 0x00, 0x0F, 0x80, //         ####                #####
	0x00, 0xF0, 0x00, 0x07, 0xE0, //         ####                 ######
	0x7F, 0xFF, 0xFF, 0xFF, 0xE0, //  ##################################
	0x7F, 0xFF, 0xFF, 0xFF, 0xE0, //  ##################################
	0x7F, 0xFF, 0xFF, 0xFF, 0xE0, //  ##################################
	0x7F, 0xFF, 0xFF, 0xFF, 0xE0, //  ##################################
	0x00, 0xF0, 0x00, 0x00, 0x00, //         ####
	0x00, 0xF0, 0x00, 0x00, 0x00, //         ####
	0x00, 0xF0, 0x00, 0x00, 0x00, //         ####
	0x00, 0xF0, 0x00, 0x00, 0x00, //         ####
	0x00, 0xF0, 0x00, 0x00, 0x00, //         ####


	// @515 '5' (21 pixels wide)
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x1E, 0x00, 0x00, 0x00, 0x00, //    ####
	0x3C, 0x00, 0x1F, 0x80, 0x00, //   ####             ######
	0x3C, 0x00, 0x3F, 0xFF, 0xE0, //   ####            #################
	0x38, 0x00, 0x3F, 0xFF, 0xE0, //   ###             #################
	0x78, 0x00, 0x3F, 0xFF, 0xE0, //  ####             #################
	0x78, 0x00, 0x3C, 0x3F, 0xE0, //  ####             ####    #########
	0x78, 0x00, 0x3C, 0x01, 0xE0, //  ####             ####         ####
	0x78, 0x00, 0x3C, 0x01, 0xE0, //  ####             ####         ####
	0x78, 0x00, 0x3C, 0x01, 0xE0, //  ####             ####         ####
	0x78, 0x00, 0x3C, 0x01, 0xE0, //  ####             ####         ####
	0x78, 0x00, 0x3C, 0x01, 0xE0, //  ####             ####         ####
	0x78, 0x00, 0x3C, 0x01, 0xE0, //  ####             ####         ####
	0x78, 0x00, 0x3C, 0x01, 0xE0, //  ####             ####         ####
	0x3C, 0x00, 0x7C, 0x01, 0xE0, //   ####           #####         ####
	0x3C, 0x00, 0x78, 0x01, 0xE0, //   ####           ####          ####
	0x3E, 0x00, 0xF8, 0x01, 0xE0, //   #####         #####          ####
	0x1F, 0xC7, 0xF0, 0x01, 0xE0, //    #######   #######           ####
	0x0F, 0xFF, 0xF0, 0x01, 0xE0, //     ################           ####
	0x07, 0xFF, 0xE0, 0x00, 0x00, //      ##############
	0x03, 0xFF, 0xC0, 0x00, 0x00, //       ############
	0x00, 0xFF, 0x00, 0x00, 0x00, //         ########
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,


	// @620 '6' (21 pixels wide)
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x3F, 0xFC, 0x00, 0x00, //           ############
	0x01, 0xFF, 0xFF, 0xC0, 0x00, //        ###################
	0x07, 0xFF, 0xFF, 0xF0, 0x00, //      #######################
	0x0F, 0xFF, 0xFF, 0xFC, 0x00, //     ##########################
	0x1F, 0xE3, 0xDF, 0xFE, 0x00, //    ########   #### ############
	0x3F, 0x00, 0xE0, 0x7F, 0x00, //   ######        ###      #######
	0x3E, 0x00, 0x70, 0x1F, 0x80, //   #####          ###       ######
	0x3C, 0x00, 0x38, 0x07, 0xC0, //   ####            ###        #####
	0x78, 0x00, 0x38, 0x03, 0xC0, //  ####             ###         ####
	0x78, 0x00, 0x1C, 0x03, 0xC0, //  ####              ###        ####
	0x78, 0x00, 0x1C, 0x01, 0xE0, //  ####              ###         ####
	0x78, 0x00, 0x1C, 0x01, 0xE0, //  ####              ###         ####
	0x78, 0x00, 0x1C, 0x01, 0xE0, //  ####              ###         ####
	0x78, 0x00, 0x3C, 0x01, 0xE0, //  ####             ####         ####
	0x3C, 0x00, 0x3C, 0x01, 0xE0, //   ####            ####         ####
	0x3E, 0x00, 0x78, 0x01, 0xE0, //   #####          ####          ####
	0x3F, 0x81, 0xF8, 0x01, 0xE0, //   #######      ######          ####
	0x1F, 0xFF, 0xF0, 0x01, 0xE0, //    #################          #####
	0x0F, 0xFF, 0xE0, 0x01, 0xE0, //     ###############          ####
	0x03, 0xFF, 0xC0, 0x00, 0x00, //       ############
	0x00, 0xFF, 0x00, 0x00, 0x00, //         ########
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,


	// @725 '7' (23 pixels wide)
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x01, 0xE0, //                                ####
	0x00, 0x00, 0x00, 0x01, 0xE0, //                                ####
	0x00, 0x00, 0x00, 0x01, 0xE0, //                                ####
	0x00, 0x00, 0x00, 0x01, 0xE0, //                                ####
	0x00, 0x00, 0x00, 0x01, 0xE0, //                                ####
	0x40, 0x00, 0x00, 0x01, 0xE0, //  #                             ####
	0x70, 0x00, 0x00, 0x01, 0xE0, //  ###                           ####
	0x7E, 0x00, 0x00, 0x01, 0xE0, //  ######                        ####
	0x7F, 0x80, 0x00, 0x01, 0xE0, //  ########                      ####
	0x7F, 0xE0, 0x00, 0x01, 0xE0, //  ##########                    ####
	0x1F, 0xF8, 0x00, 0x01, 0xE0, //    ##########                  ####
	0x07, 0xFE, 0x00, 0x01, 0xE0, //      ##########                ####
	0x00, 0xFF, 0xC0, 0x01, 0xE0, //         ##########             ####
	0x00, 0x3F, 0xF0, 0x01, 0xE0, //           ##########           ####
	0x00, 0x0F, 0xFC, 0x01, 0xE0, //             ##########         ####
	0x00, 0x01, 0xFF, 0x01, 0xE0, //                #########       ####
	0x00, 0x00, 0x7F, 0xC1, 0xE0, //                  #########     ####
	0x00, 0x00, 0x1F, 0xF9, 0xE0, //                    ##########  ####
	0x00, 0x00, 0x07, 0xFF, 0xE0, //                      ##############
	0x00, 0x00, 0x00, 0xFF, 0xE0, //                         ###########
	0x00, 0x00, 0x00, 0x3F, 0xE0, //                           #########
	0x00, 0x00, 0x00, 0x0F, 0xE0, //                             #######
	0x00, 0x00, 0x00, 0x03, 0xE0, //                               #####
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,


	// @840 '8' (21 pixels wide)
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x01, 0xF8, 0x00, 0x00, 0x00, //        ######
	0x07, 0xFE, 0x00, 0xFC, 0x00, //      ##########         ######
	0x0F, 0xFF, 0x03, 0xFF, 0x00, //     ############      ##########
	0x1F, 0xFF, 0x87, 0xFF, 0x80, //    ##############    ############
	0x3F, 0x0F, 0xCF, 0xFF, 0x80, //   ######    ######  #############
	0x3C, 0x03, 0xDF, 0x87, 0xC0, //   ####        #### ######    #####
	0x78, 0x01, 0xFE, 0x03, 0xC0, //  ####          ########       ####
	0x78, 0x00, 0xFC, 0x01, 0xE0, //  ####           ######         ####
	0x78, 0x00, 0x7C, 0x01, 0xE0, //  ####            #####         ####
	0x78, 0x00, 0x78, 0x01, 0xE0, //  ####            ####          ####
	0x78, 0x00, 0x78, 0x01, 0xE0, //  ####            ####          ####
	0x78, 0x00, 0x78, 0x01, 0xE0, //  ####            ####          ####
	0x78, 0x00, 0xFC, 0x01, 0xE0, //  ####           ######         ####
	0x78, 0x01, 0xFC, 0x01, 0xE0, //  ####          #######         ####
	0x3C, 0x01, 0xFE, 0x03, 0xC0, //   ####         ########       ####
	0x3C, 0x03, 0xCF, 0x87, 0xC0, //   ####        ####  #####    #####
	0x3F, 0x0F, 0xC7, 0xFF, 0x80, //   ######    ######   ############
	0x1F, 0xFF, 0x87, 0xFF, 0x80, //    ##############    ############
	0x0F, 0xFF, 0x01, 0xFF, 0x00, //     ############       #########
	0x07, 0xFE, 0x00, 0xFC, 0x00, //      ##########         ######
	0x01, 0xF8, 0x00, 0x00, 0x00, //        ######
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,


	// @945 '9' (21 pixels wide)
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x0F, 0xF0, 0x00, //                     ########
	0x00, 0x00, 0x3F, 0xFC, 0x00, //                   ############
	0x00, 0x00, 0x7F, 0xFF, 0x00, //                  ###############
	0x78, 0x00, 0xFF, 0xFF, 0x80, //  ####           #################
	0x78, 0x01, 0xF8, 0x1F, 0xC0, //  ####          ######      #######
	0x70, 0x01, 0xE0, 0x07, 0xC0, //  ###           ####          #####
	0x70, 0x03, 0xC0, 0x03, 0xC0, //  ###          ####            ####
	0x70, 0x03, 0xC0, 0x01, 0xE0, //  ###          ####             ####
	0x70, 0x03, 0x80, 0x01, 0xE0, //  ###          ###              ####
	0x78, 0x03, 0x80, 0x01, 0xE0, //  ####         ###              ####
	0x78, 0x03, 0x80, 0x01, 0xE0, //  ####         ###              ####
	0x3C, 0x03, 0x80, 0x01, 0xE0, //   ####        ###              ####
	0x3C, 0x01, 0xC0, 0x01, 0xE0, //   ####         ###             ####
	0x3E, 0x01, 0xC0, 0x03, 0xC0, //   #####        ###            ####
	0x1F, 0x80, 0xE0, 0x07, 0xC0, //    ######       ###          #####
	0x0F, 0xE0, 0x70, 0x0F, 0xC0, //     #######      ###        ######
	0x07, 0xFF, 0xBC, 0x7F, 0x80, //      ############ ####   ########
	0x03, 0xFF, 0xFF, 0xFF, 0x00, //       ##########################
	0x00, 0xFF, 0xFF, 0xFE, 0x00, //         #######################
	0x00, 0x3F, 0xFF, 0xF8, 0x00, //           ###################
	0x00, 0x03, 0xFF, 0xC0, 0x00, //               ############
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00,


	// @1050 ':' (6 pixels wide)
	0x07, 0xC0, 0x00, 0x7C, 0x00,//   #####               #####
	0x0F, 0xE0, 0x00, 0xFE, 0x00, // #######             #######
	0x0F, 0xE0, 0x00, 0xFE, 0x00, // #######             #######
	0x0F, 0xE0, 0x00, 0xFE, 0x00, // #######             #######
	0x0F, 0xE0, 0x00, 0xFE, 0x00, // #######             #######
	0x07, 0xC0, 0x00, 0x7C, 0x00, //  #####               #####
};

void shiftout(uint8_t data){
	for(uint8_t i=0;i<8;i++){
		if(data&0b10000000){
			PORTD|=0b01000000;
			}else{
			PORTD&=0b10111111;
		}
		PORTD|=0b00100000;
		PORTD&=0b11011111;
		data<<=1;
	}
}
void lcd_send_com(uint8_t data){
	PORTB=0x00;
	shiftout(data);
	PORTB=0x10;
}
void lcd_send_data(uint8_t data){
	PORTB=0x01;
	shiftout(data);
	PORTB=0x10;
}
void lcd_res(){
		PORTD|=0b10000000;
		_delay_ms(1);
		PORTD&=0b01111111;
		_delay_ms(10);
		PORTD|=0b10000000;
		lcd_send_com(0xAE);
		lcd_send_com(0xD5);
		lcd_send_com(0xF0);
		lcd_send_com(0xA8);
		lcd_send_com(0x3F);
		lcd_send_com(0xD3);
		lcd_send_com(0x0);
		lcd_send_com(0x40);
		lcd_send_com(0x8D);
		lcd_send_com(0x14);
		lcd_send_com(0x20);
		lcd_send_com(0x00);
		lcd_send_com(0xA1);
		lcd_send_com(0xC8);
		lcd_send_com(0xDA);
		lcd_send_com(0x12);
		lcd_send_com(0x81);
		lcd_send_com(0x00);
		lcd_send_com(0xD9);
		lcd_send_com(0xF1);
		lcd_send_com(0xDB);
		lcd_send_com(0x40);
		lcd_send_com(0xA4);
		lcd_send_com(0xA6);
		for(uint16_t u=0; u<1024;u++){
			lcd_send_data(0b00000000);
		}
		lcd_send_com(0xAF);
			
	};
void big_time(uint8_t hh,uint8_t hl,uint8_t mh, uint8_t ml){
	uint8_t time_arr[]={hh, hl,10, mh, ml};
	uint8_t latest=5;
	for (uint8_t w=0;w<5;w++){
		lcd_send_com(0x22);
		lcd_send_com(0x02);
		lcd_send_com(0x06);
		lcd_send_com(0x21);
		lcd_send_com(latest);
		uint16_t end_point=0;
		if (w==2){
				end_point=266;
				latest-=20;
			}
			else{
				end_point=(time_arr[w]+1)*26;
			}
		lcd_send_com(latest+25);
		latest+=28;
		for(uint8_t e=0;e<5;e++){
			for(uint16_t y=time_arr[w]*26;y<end_point;y++){
				lcd_send_data(pgm_read_byte(&font36px_line0[4-e+y*5]));
			}
		}
	}
}

void word_out(uint8_t input[],uint8_t len){
	for(uint8_t w=0;w<len;w++){
		if(input[w]==0xFF){for(uint8_t q=0;q<5;q++){lcd_send_data(0x00);} continue;}
		for(uint16_t r=input[w]*5;r<(input[w]+1)*5;r++){
			lcd_send_data(pgm_read_byte(&font_small[r]));
				}
		lcd_send_data(0x00);
		}
}
void time_out(){
	ds3231_read_time(time);
	if(minutes_old!=time[1]){
		big_time(time[0]/10,time[0]%10,time[1]/10,time[1]%10);
		ds3231_read_data(date);
		for (uint8_t h=0;h<8;h++){
			if(h%2==0){date[7-h]=date[(7-h)>>1]%10;}
			else{date[7-h]=date[(7-h)>>1]/10;}
		}
		lcd_send_com(0x22);
		lcd_send_com(0x00);
		lcd_send_com(0x07);
		lcd_send_com(0x21);
		lcd_send_com(0x02);
		lcd_send_com(0x79);
		for(uint8_t u=2;u<8;u++){
			for(uint8_t r=date[u]*5;r<(date[u]+1)*5;r++){lcd_send_data(pgm_read_byte(&font8px[r]));}
			lcd_send_data(0x00);
			if(u%2==1&&u!=7){
				for(uint8_t r=0;r<5;r++){lcd_send_data(pgm_read_byte(&font8px[54-r]));}
			}
		}
	}
	minutes_old=time[1];
}

void sel_menu(uint8_t pos){
	menu_selected=pos;
	switch(pos){
		case 1:
		
		break;
		case 2:
		
		break;
		case 3:
		
		break;
		case 4:
		
		break;
	}
}

//dir 0-dn 1-up
void show_cursor(uint8_t dir){
	lcd_send_com(0x22);
	lcd_send_com(menu_now-1);
	lcd_send_com(menu_now-1);
	lcd_send_com(0x21);
	lcd_send_com(0x00);
	lcd_send_com(0x04);
for(uint8_t r=0;r<5;r++){lcd_send_data(pgm_read_byte(&font_small[69*5+r]));}
	
			lcd_send_com(0x22);
				if(dir==0){
					if(menu_now!=1){
						lcd_send_com(menu_now-2);
						lcd_send_com(menu_now-2);
					}else{
						lcd_send_com(MENU_LENGTH-1);
						lcd_send_com(MENU_LENGTH-1);
					}
				}else{
					if(menu_now==MENU_LENGTH){
						lcd_send_com(0x00);
						lcd_send_com(0x00);
						}else{
						lcd_send_com(menu_now);
						lcd_send_com(menu_now);
					}
				}
				lcd_send_com(0x21);
				lcd_send_com(0x00);
				lcd_send_com(0x07);
				for(uint8_t r=0;r<8;r++){
					lcd_send_data(0x00);
					}
	
}

void up_b(){
	if(state&0x08&&menu_selected==0){
	if(!(PINB&4)){
		state|=0x10;
		if(!(state&0x20)){
			bt_wait_sel_u=WAIT; state|=0x20;
			}
		else{
			if(bt_wait_sel_u>0){
				bt_wait_sel_u--;
				}
			}
		}else{
		if(state&0x10){
			state&=0xEF;
			if(bt_wait_sel_u>WAIT/2){
				state&=0xDF;
				if(menu_now<MENU_LENGTH){
					menu_now++;
					}
				else{
					menu_now=1;
					}
					//lcd_send_data(0x42);
			}else{
				state&=0xDF;
				}
			show_cursor(0x00);
			}
		}
	}
}
void dn_b(){
	if(state&0x08&&menu_selected==0){
		if(!(PINB&8)){
			state|=0x40;
			if(!(state&0x80)){bt_wait_sel_d=WAIT; state|=0x80;}
			else{if(bt_wait_sel_d>0){bt_wait_sel_d--;}}
			}else{
			if(state&0x40){
				state&=0xBF;
				if(bt_wait_sel_d>WAIT/2){
					state&=0x7F;
					if(menu_now>1){menu_now--;}
						else{menu_now=MENU_LENGTH;}
						//lcd_send_data(0x81);
				}else{
					state&=0x7F;
					}
				show_cursor(0x01);
			}
		}
	}
}
void short_press(){
	if(!(state&0x08)){
		if(!(state&0x04)){
			state|=0x04;
			lcd_res();
			minutes_old=0xff;
		}
		time_out();
		delay=DEL;
		}else{
		//sel_menu(menu_now);
		}
	};
//FRENCH BAUGETTE 	uint8_t baugette[]={49,26,5,24,28,0xff,5,25,5,0xff,29,18,8,21,0xff,12,31,3,10,8,21,0xff,20,16,0,13,22,19,7,17,10,8,21,0xff,1,19,11,14,10,64,4,0,0xff,2,27,15,5,9,0xff,23,0,30,65};	
void long_press(){
	if(!(state&0x08)){
		state|=0x08;
		lcd_res();
		menu_now=1;
		lcd_send_data(0xff);
		lcd_send_data(0xff);
	}
	else{
		state&=0xf7;/*lcd_send_data(0xaa);*/ lcd_send_com(0xAE);
		}
	};
//state |dn 1-st press|dn pressed|up 1-st press|up pressed|    in menu mode|led is running|press state|1-st press
void button_pwr(){
	if(!(PINB&2)){
		state|=0x02;
		if(!(state&0x01)){bt_wait=WAIT; state|=0x01;}
			else{if(bt_wait>0){bt_wait--;}}
	}else{
		if(state&0x02){
					state&=0xFC;
			if(bt_wait>WAIT/2){short_press();}
				else{lcd_send_data(0xff); long_press();}			
		}
	}
}
ISR(TIMER0_OVF_vect){
	sleep_disable();
	button_pwr();
	up_b();
	dn_b();
	if(delay>0){delay--;}else{state&=0xFB;  if(!(state&0x08))lcd_send_com(0xAE);}
	
}
int main(void)
{
	DDRB=0xC1;
	DDRD=0xE0;
	PORTD=0x00;
	ACSR |= (1 << ACD);
	
ds3231_init();
ds3231_write_reg(0x0E,0x00);

set_sleep_mode(SLEEP_MODE_IDLE);
TIMSK=0x01;
TCCR0=0x04;
TCNT0=0x00;
sei();
    while (1) 
    {
		sleep_enable();
		sleep_cpu();
}
	}